# 项目背景

随着大模型和计算机视觉技术的进步，我们现在有机会实现对文档中公式的深度解析和智能问答。这项技术将极大地解放科研人员和工程师，使他们能够更高效地从海量文献中提取知识、验证理论、进行数据分析，并在智能教育、科学计算、专利分析等领域具有革命性的应用潜力。

# 项目任务

本项目旨在构建一个高精度、端到端的文档公式智能问答系统（Formula-QAS），实现对文档中公式的准确识别、结构解析、语义理解和基于公式的精确计算与问答。

用户进行提问 -》关联到一个计算公式 -》 抽取得到输入的参数 -》 代入计算公式 进行计算 -》 得到结果 -》 汇总进行回答。

最终将整个公式解析与问答服务封装为MCP服务，并构架一个智能问答系统，基于MCP服务，实现对文档中公式的智能问答。
1. 能回答关于公式的**语义问题**（如：公式$E=mc^2$中的$E$代表什么？）。
2. 能根据文档中提供的多个公式和数据，进行**多步链式推理和计算**。


变压器公式进行合作，100款变压器，输入 功率、尺寸、温度、湿度、电量转换比例 -》价格的计算
xx商品的销量和仓储计算，1000个商品，历史销量、未来销量、仓库容量 -》最优的备货量
> 不适合常规的大模型，不适合常规的rag（知识问答）；
> 每款变压器 / 每个商品，都有自己的计算逻辑，自己的额外的参数；


# 实施步骤

- 文档解析（mineru、deepseek-ocr、qwen3-vl模型）：将文档中的公式进行结构解析，并生成对应的$\LaTeX$公式。
- 公式提取与计算（latex 公式 -》 py代码）：通过结构解析后的$\LaTeX$公式，进行参数提取与代入计算，并返回计算结果。
- 智能问答（接受到用户的输入信息 -》识别最合适的公式-》代入的参数 -》计算结果 -》汇总进行回答）：基于公式识别与解析结果，实现对文档中公式的智能问答。

MCP 服务 + 符号计算引擎（工程主导计算），更加推荐（人工的校验过程）。

> MCP是确定的工具，启动fastmcp server， 工具已经确定的。

**将公式解析和计算视为一个严谨的工程问题**，通过专有模型和符号计算服务来保证高精度和高性能。在MCP服务中集成**小型的语言模型或RAG模块**，专门负责公式周围文本的语义分析，例如：
1.  **变量语义提取**：识别公式$A=\pi r^2$周围的文本，确定“$r$是半径”。
2.  **上下文参数提取**：从多页文本中准确找到计算所需的数值。

| 优势 (Pros) | 劣势 (Cons) | 适用场景 |
| :--- | :--- | :--- |
| **计算精度与性能保障**：使用`sympy`/`numpy`等专业库，**计算精度可达项目要求的$10^{-6}$**，并且计算速度快。 | **语义理解不足**：难以处理复杂的自然语言问答，例如“这个公式的物理意义是什么？”或“请解释公式中的$\alpha$变量”。 | 适用于需要**高精度、快速、批量**进行公式代入计算、求解和验证的场景。 |
| **成本低、易部署**：计算服务轻量级，易于封装为MCP微服务，具有高并发能力和低延迟。 | **对PDF解析要求高**：需要非常准确地将公式图像**结构化**为$\LaTeX$或MathML，并准确地将**文本中的参数数值**提取并绑定到正确的变量。 | **是实现“准确的计算”和“部署为MCP服务”目标的最佳路线。** |
| **计算过程可验证**：服务可以设计为输出详细的计算日志和步骤，易于溯源和验证。 | | |

实施步骤：
  - 步骤1：pdf公式的解析，将文档中的公式进行结构解析，并生成对应的$\LaTeX$公式。
  - 步骤2: 定义mcp服务，并且将每一个公式整理为mcp 的一个可执行的tool 或 sympy的计算过程。
  - 步骤3: 得到用户提问的时候，需要选择对应的tool
    - 通过rag的步骤（用户的提问 与 公式 进行相似度计算，也可以加入rerank 过程，筛选top1/3公式） -》 tool 白名单
  - 步骤4: 调用对应的tool，执行，得到结果，汇总得到回答。



# 相关的库

- https://huggingface.co/Qwen/Qwen3-Embedding-8B
- https://huggingface.co/Qwen/Qwen3-Rerank-8B
- fastmcp、vllm

# 实现思路
  - 步骤1：将pdf的内容读取到.csv文件的content列中，并添加定义好的mcp工具名称为元数据。
  - 步骤2: 读取.csv中的content列，对content进行embedding。
  - 步骤3: 得到用户提问的时候，跟content的embedding进行相似度计算，得到top 5，并且的到相关的formula函数名
  - 步骤4: 将用户提问，top 5的content传入agent，调用对应的tool，执行，得到结果，汇总得到回答。
