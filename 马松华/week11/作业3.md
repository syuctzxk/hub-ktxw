## 📊 总体设计原则

### 核心设计思路：

- **统一存储**：所有模态数据存储在同一个Collection中
- **统一检索**：支持跨模态语义检索
- **模态分离**：原始内容与向量表示分离存储
- **元数据丰富**：充分存储检索和过滤所需的元数据

## 🗂️ Milvus集合结构设计

### Collection名称：`multimodal_rag`

| 字段名            | 数据类型     | 维度 | 索引类型 | 描述                                                         |
| :---------------- | :----------- | :--- | :------- | :----------------------------------------------------------- |
| `id`              | VARCHAR      | -    | -        | 主键，格式：`{modality}_{timestamp}_{uuid}`                  |
| `embedding`       | FLOAT_VECTOR | 1024 | HNSW/IP  | 统一的多模态向量                                             |
| `text_embedding`  | FLOAT_VECTOR | 768  | HNSW     | 纯文本向量（备用）                                           |
| `image_embedding` | FLOAT_VECTOR | 512  | HNSW     | 图像向量（备用）                                             |
| `modality`        | VARCHAR      | -    | -        | 内容类型：`text`/`image`/`table`/`mixed`                     |
| `content_type`    | VARCHAR      | -    | -        | 具体类型：`paragraph`/`section`/`figure`/`chart`/`data_table`等 |
| `content_hash`    | VARCHAR      | -    | -        | 内容MD5哈希，用于去重                                        |

## 📝 文本数据字段设计

| 字段名        | 数据类型 | 索引     | 描述                       |
| :------------ | :------- | :------- | :------------------------- |
| `raw_text`    | VARCHAR  | 倒排索引 | 原始文本内容               |
| `clean_text`  | VARCHAR  | -        | 清洗后的文本（去停用词等） |
| `text_length` | INT      | -        | 文本长度（字符数）         |
| `language`    | VARCHAR  | -        | 语言代码：`zh`/`en`等      |
| `entities`    | JSON     | -        | 提取的命名实体             |
| `keywords`    | JSON     | -        | 提取的关键词及权重         |
| `summary`     | VARCHAR  | -        | 文本摘要                   |

## 🖼️ 图像数据字段设计

| 字段名             | 数据类型 | 索引     | 描述                                          |
| :----------------- | :------- | :------- | :-------------------------------------------- |
| `image_url`        | VARCHAR  | -        | 图像存储路径或URL                             |
| `image_size`       | JSON     | -        | 图像尺寸：`{"width": 800, "height": 600}`     |
| `image_format`     | VARCHAR  | -        | 格式：`jpg`/`png`/`gif`等                     |
| `dominant_colors`  | JSON     | -        | 主色调RGB值数组                               |
| `visual_concepts`  | JSON     | 倒排索引 | 视觉概念标签：`["person", "car", "building"]` |
| `object_detection` | JSON     | -        | 目标检测结果                                  |
| `ocr_text`         | VARCHAR  | 倒排索引 | 图像中的识别文字                              |
| `caption`          | VARCHAR  | -        | 自动生成的图像描述                            |

## 📊 表格数据字段设计

| 字段名            | 数据类型 | 索引     | 描述                 |
| :---------------- | :------- | :------- | :------------------- |
| `table_structure` | JSON     | -        | 表格结构信息         |
| `table_data`      | JSON     | -        | 表格数据（JSON格式） |
| `table_summary`   | VARCHAR  | -        | 表格内容摘要         |
| `column_names`    | JSON     | 倒排索引 | 列名数组             |
| `data_types`      | JSON     | -        | 各列数据类型         |
| `row_count`       | INT      | -        | 行数                 |
| `column_count`    | INT      | -        | 列数                 |
| `statistics`      | JSON     | -        | 数值列统计信息       |

## 🏷️ 元数据字段设计

### 文档级元数据

| 字段名          | 数据类型 | 索引     | 描述             |
| :-------------- | :------- | :------- | :--------------- |
| `document_id`   | VARCHAR  | -        | 所属文档ID       |
| `collection_id` | VARCHAR  | -        | 所属集合ID       |
| `chunk_index`   | INT      | -        | 在文档中的块索引 |
| `total_chunks`  | INT      | -        | 文档总块数       |
| `file_name`     | VARCHAR  | 倒排索引 | 原始文件名       |
| `file_path`     | VARCHAR  | -        | 文件存储路径     |
| `file_size`     | INT      | -        | 文件大小（字节） |

### 业务元数据

| 字段名         | 数据类型 | 索引     | 描述                                |
| :------------- | :------- | :------- | :---------------------------------- |
| `source_type`  | VARCHAR  | -        | 数据来源：`upload`/`crawl`/`api`等  |
| `access_level` | VARCHAR  | -        | 访问权限：`public`/`private`/`team` |
| `category`     | VARCHAR  | 倒排索引 | 分类标签                            |
| `tags`         | JSON     | 倒排索引 | 标签数组                            |
| `author`       | VARCHAR  | 倒排索引 | 作者/创建者                         |
| `created_time` | INT64    | -        | 创建时间戳                          |
| `updated_time` | INT64    | -        | 更新时间戳                          |
| `version`      | VARCHAR  | -        | 数据版本                            |

### 处理状态元数据

| 字段名              | 数据类型 | 索引 | 描述                                                  |
| :------------------ | :------- | :--- | :---------------------------------------------------- |
| `processing_status` | VARCHAR  | -    | 处理状态：`pending`/`processing`/`completed`/`failed` |
| `embedding_model`   | VARCHAR  | -    | 使用的嵌入模型版本                                    |
| `processing_errors` | JSON     | -    | 处理错误信息                                          |
| `quality_score`     | FLOAT    | -    | 内容质量评分                                          |

## 🔗 关联关系设计

### 跨模态关联字段

| 字段名             | 数据类型 | 描述                       |
| :----------------- | :------- | :------------------------- |
| `parent_id`        | VARCHAR  | 父内容块ID（用于分块关联） |
| `related_ids`      | JSON     | 相关内容的ID数组           |
| `cross_references` | JSON     | 跨模态引用关系             |
| `semantic_group`   | VARCHAR  | 语义分组ID                 |

## 🎯 索引策略设计

### 向量索引配置

json

```
{
  "embedding_index": {
    "index_type": "HNSW",
    "metric_type": "COSINE",
    "params": {
      "M": 16,
      "efConstruction": 200
    }
  },
  "text_embedding_index": {
    "index_type": "HNSW", 
    "metric_type": "COSINE",
    "params": {
      "M": 12,
      "efConstruction": 150
    }
  }
}
```



### 标量字段索引

| 字段名         | 索引类型 | 用途           |
| :------------- | :------- | :------------- |
| `modality`     | 倒排索引 | 按模态类型过滤 |
| `content_type` | 倒排索引 | 按内容类型过滤 |
| `tags`         | 倒排索引 | 标签搜索       |
| `category`     | 倒排索引 | 分类过滤       |
| `created_time` | 范围索引 | 时间范围查询   |

## 💾 分区策略

### 按时间分区

text

```
multimodal_rag_2024_q1
multimodal_rag_2024_q2  
multimodal_rag_2024_q3
multimodal_rag_2024_q4
```



### 按业务分区

text

```
multimodal_rag_public
multimodal_rag_private
multimodal_rag_archived
```



## 🔍 查询优化字段

### 预计算字段

| 字段名             | 数据类型 | 描述                 |
| :----------------- | :------- | :------------------- |
| `search_boost`     | FLOAT    | 搜索权重提升因子     |
| `popularity_score` | FLOAT    | 内容热度评分         |
| `freshness_score`  | FLOAT    | 新鲜度评分           |
| `composite_score`  | FLOAT    | 综合评分（用于排序） |

### 统计字段

| 字段名            | 数据类型 | 描述         |
| :---------------- | :------- | :----------- |
| `access_count`    | INT      | 访问次数     |
| `retrieval_count` | INT      | 检索命中次数 |
| `last_accessed`   | INT64    | 最后访问时间 |

## 🛡️ 数据安全字段

### 权限控制

| 字段名           | 数据类型 | 描述               |
| :--------------- | :------- | :----------------- |
| `owner_id`       | VARCHAR  | 所有者ID           |
| `allowed_users`  | JSON     | 允许访问的用户列表 |
| `allowed_teams`  | JSON     | 允许访问的团队列表 |
| `encryption_key` | VARCHAR  | 加密密钥ID         |

## 📈 性能优化建议

### 存储优化

1. **向量维度**：根据模型输出统一为固定维度
2. **字段压缩**：对JSON字段使用压缩存储
3. **分区策略**：根据查询模式设计分区
4. **索引选择**：平衡查询性能与存储开销

### 查询优化

1. **预过滤**：利用标量字段进行预过滤
2. **多阶段检索**：粗排 + 精排策略
3. **缓存策略**：热点数据缓存
4. **批量操作**：支持批量插入和查询

这个数据结构设计充分考虑了多模态RAG系统的需求，支持灵活的检索、过滤和排序，同时保证了系统的扩展性和性能。
