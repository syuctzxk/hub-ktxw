## 1. 项目概述

本项目是一个基于FastAPI后端和Streamlit前端的股票BI智能助手应用，提供用户管理、股票数据查询、智能聊天等功能。

### 技术栈
- **后端**：FastAPI + Python
- **前端**：Streamlit + Python
- **API调用**：REST API + MCP服务
- **股票数据**：通过AutoStock API获取实时股票数据

## 2. API接口详细说明

### 2.1 健康检查接口

| 接口路径 | 方法 | 功能描述 | 参数 | 返回结构 |
|---------|------|----------|------|----------|
| `/v1/healthy` | GET | 检查服务健康状态 | 无 | `{"code": 200, "message": "ok", "data": []}` |

### 2.2 用户管理接口 (/v1/users)

| 接口路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功返回结构 |
|---------|------|----------|-------------|------------|
| `/v1/users/login` | POST | 用户登录 | `{"user_name": "用户名", "password": "密码"}` | `{"code": 200, "message": "用户登陆成功", "data": []}` |
| `/v1/users/register` | POST | 用户注册 | `{"user_name": "用户名", "password": "密码", "user_role": "角色"}` | `{"code": 200, "message": "用户注册成功", "data": []}` |
| `/v1/users/reset-password` | POST | 重置密码 | `{"user_name": "用户名", "password": "旧密码", "new_password": "新密码"}` | `{"code": 200, "message": "密码重置成功", "data": []}` |
| `/v1/users/info` | POST | 获取用户信息 | `{"user_name": "用户名"}` | `{"code": 200, "message": "获取用户信息成功", "data": [{"user_id": 1, "user_name": "...", "user_role": "...", "register_time": "...", "status": true}]}` |
| `/v1/users/reset-info` | POST | 修改用户信息 | `{"user_name": "用户名", "user_role": "新角色", "status": true}` | `{"code": 200, "message": "用户信息修改成功", "data": []}` |
| `/v1/users/delete` | POST | 删除用户 | `{"user_name": "用户名"}` | `{"code": 200, "message": "用户删除成功", "data": []}` |
| `/v1/users/list` | POST | 获取用户列表 | 无 | `{"code": 200, "message": "ok", "data": [{"user_id": 1, "user_name": "...", "user_role": "...", "register_time": "...", "status": true}]}` |

### 2.3 聊天管理接口 (/v1/chat)

| 接口路径 | 方法 | 功能描述 | 请求体 (JSON) | 返回类型 |
|---------|------|----------|-------------|----------|
| `/v1/chat/` | POST | 智能对话 | `{"user_name": "用户名", "task": "任务", "session_id": "会话ID", "content": "内容", "tools": ["工具列表"]}` | StreamingResponse (SSE) |
| `/v1/chat/init` | POST | 初始化聊天 | 无 | `{"code": 200, "message": "ok", "data": {"session_id": "生成的会话ID"}}` |
| `/v1/chat/get` | POST | 获取聊天记录 | `{"session_id": "会话ID"}` | `{"code": 200, "message": "ok", "data": [{"对话记录"}]}` |
| `/v1/chat/delete` | POST | 删除聊天记录 | `{"session_id": "会话ID"}` | `{"code": 200, "message": "ok", "data": []}` |
| `/v1/chat/list` | POST | 获取用户聊天列表 | `{"user_name": "用户名"}` | `{"code": 200, "message": "ok", "data": [{"聊天会话列表"}]}` |
| `/v1/chat/feedback` | POST | 聊天反馈 | `{"session_id": "会话ID", "message_id": 1, "feedback": true}` | `{"code": 200, "message": "ok", "data": []}` |

### 2.4 数据管理接口 (/v1/data)

| 接口路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功返回结构 |
|---------|------|----------|-------------|------------|
| `/v1/data/download` | POST | 下载数据 | 未实现 | - |
| `/v1/data/create` | POST | 创建数据 | 未实现 | - |
| `/v1/data/upload` | POST | 上传数据 | 未实现 | - |
| `/v1/data/delete` | POST | 删除数据 | 未实现 | - |

### 2.5 股票收藏管理接口 (/v1/stock)

| 接口路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功返回结构 |
|---------|------|----------|-------------|------------|
| `/v1/stock/list_fav_stock` | POST | 获取用户收藏股票 | `{"user_name": "用户名"}` | `{"code": 200, "message": "获取用户所有股票成功", "data": [{"股票代码列表"}]}` |
| `/v1/stock/del_fav_stock` | POST | 删除收藏股票 | `{"user_name": "用户名", "stock_code": "股票代码"}` | `{"code": 200, "message": "删除成功", "data": []}` |
| `/v1/stock/add_fav_stock` | POST | 添加收藏股票 | `{"user_name": "用户名", "stock_code": "股票代码"}` | `{"code": 200, "message": "添加成功", "data": []}` |
| `/v1/stock/clear_fav_stock` | POST | 清空收藏股票 | `{"user_name": "用户名"}` | `{"code": 200, "message": "删除成功", "data": []}` |

### 2.6 底层股票API接口 (/stock)

| 接口路径 | 方法 | 功能描述 | 查询参数 | 返回结构 |
|---------|------|----------|---------|----------|
| `/stock/get_stock_code` | GET | 获取所有股票代码 | `keyword`: 支持代码和名称模糊查询 | 股票列表JSON |
| `/stock/get_index_code` | GET | 获取所有指数代码 | 无 | 指数列表JSON |
| `/stock/get_industry_code` | GET | 获取板块数据 | 无 | 板块列表JSON |
| `/stock/get_board_info` | GET | 获取大盘数据 | 无 | 大盘指数JSON |
| `/stock/get_stock_rank` | GET | 获取股票排行 | `node`: 股票市场/板块代码<br>`industryCode`: 行业代码<br>`pageIndex`: 页码<br>`pageSize`: 每页大小<br>`sort`: 排序字段<br>`asc`: 排序方式 | 股票排行JSON |
| `/stock/get_month_line` | GET | 获取月K线 | `code`: 股票代码<br>`startDate`: 开始时间<br>`endDate`: 结束时间<br>`type`: 复权类型 | K线数据JSON |
| `/stock/get_week_line` | GET | 获取周K线 | `code`: 股票代码<br>`startDate`: 开始时间<br>`endDate`: 结束时间<br>`type`: 复权类型 | K线数据JSON |
| `/stock/get_day_line` | GET | 获取日K线 | `code`: 股票代码<br>`startDate`: 开始时间<br>`endDate`: 结束时间<br>`type`: 复权类型 | K线数据JSON |
| `/stock/get_stock_info` | GET | 获取股票基础信息 | `code`: 股票代码 | 股票信息JSON |
| `/stock/get_stock_minute_data` | GET | 获取分时信息 | `code`: 股票代码 | 分时数据JSON |

### 2.7 MCP服务接口

| 接口名称 | 功能描述 | 参数 | 返回值 |
|---------|----------|------|--------|
| `get_today_familous_saying` | 获取今日名人名言 | 无 | 名言文本 |
| `get_today_motivation_saying` | 获取今日励志名言 | 无 | 励志名言文本 |
| `get_today_working_saying` | 获取今日工作鸡汤 | 无 | 工作鸡汤文本 |

## 3. 前端页面与接口交互

### 3.1 账户中心

| 页面 | 主要功能 | 调用接口 |
|------|----------|----------|
| 用户注册 | 注册新用户 | `/v1/users/register` |
| 登录/退出 | 用户登录 | `/v1/users/login` |
| 个人信息 | 查看用户信息 | `/v1/users/info` |
| 修改信息 | 修改用户信息 | `/v1/users/reset-info` |
| 删除账户 | 删除用户账户 | `/v1/users/delete` |
| 列举账户 | 查看所有用户 | `/v1/users/list` |

### 3.2 股票中心

| 页面 | 主要功能 | 调用接口 |
|------|----------|----------|
| 股票搜索 | 搜索股票 | `/stock/get_stock_code` |
| 行业概览 | 查看行业数据 | `/stock/get_industry_code` |
| 市场看板 | 查看大盘指数 | `/stock/get_board_info` |
| 股票排行 | 查看股票排行 | `/stock/get_stock_rank` |
| 股票信息 | 查看股票详情 | `/stock/get_stock_info` |
| 股票K线图 | 查看股票K线 | `/stock/get_day_line`、`/stock/get_week_line`、`/stock/get_month_line` |
| 当日交易 | 查看分时数据 | `/stock/get_stock_minute_data` |
| 股票收藏 | 管理收藏股票 | `/v1/stock/list_fav_stock`、`/v1/stock/add_fav_stock`、`/v1/stock/del_fav_stock`、`/v1/stock/clear_fav_stock` |

### 3.3 数据中心

| 页面 | 主要功能 | 调用接口 |
|------|----------|----------|
| 数据列表 | 查看数据列表 | 未实现 |
| 数据管理 | 管理数据 | 未实现 |

### 3.4 智能问答

| 页面 | 主要功能 | 调用接口 |
|------|----------|----------|
| 对话历史 | 查看聊天历史 | `/v1/chat/list`、`/v1/chat/get` |
| 通用对话 | 与AI助手对话 | `/v1/chat/init`、`/v1/chat/` |

### 3.5 工具中心

| 页面 | 主要功能 | 调用接口 |
|------|----------|----------|
| MCP列表 | 查看MCP服务列表 | MCP服务接口 |
| MCP调试 | 调试MCP服务 | MCP服务接口 |

## 4. 数据模型定义

### 4.1 用户相关模型

```python
class User(BaseModel):
    user_id: int
    user_name: str
    user_role: str
    register_time: datetime
    status: bool

class RequestForUserLogin(BaseModel):
    user_name: str
    password: str

class RequestForUserRegister(BaseModel):
    user_name: str
    password: str
    user_role: str

class RequestForUserResetPassword(BaseModel):
    user_name: str
    password: str
    new_password: str

class RequestForUserChangeInfo(BaseModel):
    user_name: str
    user_role: Optional[str]
    status: Optional[bool]
```

### 4.2 聊天相关模型

```python
class RequestForChat(BaseModel):
    content: str = Field(..., description="用户的提问")
    user_name: str = Field(..., description="用户名")
    session_id: Optional[str] = Field(None, description="对话session_id, 获取对话上下文")
    task: Optional[str] = Field(None, description="对话任务")
    tools: Optional[List[str]] = Field(None, description="可选的工具列表")
    # 多媒体内容字段
    image_content: Optional[str] = Field(None)
    file_content: Optional[str] = Field(None)
    url_content: Optional[str] = Field(None)
    audio_content: Optional[str] = Field(None)
    video_content: Optional[str] = Field(None)
    # 对话模式
    vison_mode: Optional[bool] = Field(False)
    deepsearch_mode: Optional[bool] = Field(False)
    sql_interpreter: Optional[bool] = Field(False)
    code_interpreter: Optional[bool] = Field(False)

class ResponseForChat(BaseModel):
    response_text: str
    session_id: Optional[str] = Field(None)
    response_code: Optional[str] = Field(None)
    response_sql: Optional[str] = Field(None)
```

### 4.3 通用响应模型

```python
class BasicResponse(BaseModel):
    code: int
    message: str
    data: Optional[Union[List[Any], Any]]
```

## 5. 前后端交互流程

### 5.1 用户登录流程

1. **前端**：用户在 `user_login.py` 页面输入用户名和密码
2. **前端**：调用 `requests.post()` 向 `/v1/users/login` 发送登录请求
3. **后端**：验证用户凭据并返回登录结果
4. **前端**：根据返回结果更新会话状态 `st.session_state.logged = True`
5. **前端**：显示登录成功信息并更新页面导航

### 5.2 股票数据查询流程

1. **前端**：用户在 `stock_board.py` 页面查看市场看板
2. **前端**：调用 `fetch_board_info()` 函数获取大盘数据
3. **前端**：通过 `requests.get()` 向 `/stock/get_board_info` 发送请求
4. **后端**：调用AutoStock API获取实时大盘数据
5. **后端**：处理数据并返回给前端
6. **前端**：将数据转换为DataFrame并显示在页面上

### 5.3 智能聊天流程

1. **前端**：用户在 `chat.py` 页面输入问题
2. **前端**：初始化聊天会话，调用 `/v1/chat/init` 获取 `session_id`
3. **前端**：调用 `/v1/chat/` 发送聊天内容，使用流式响应
4. **后端**：通过AI模型处理用户请求
5. **后端**：使用Server-Sent Events (SSE) 流式返回结果
6. **前端**：实时显示AI回复内容

## 6. 常见问题和解决方案

### 6.1 API连接错误

**问题**：无法连接到后端服务
**解决方案**：
- 确保后端服务正在运行
- 检查BASE_URL配置是否正确
- 检查网络连接是否正常

### 6.2 数据类型转换错误

**问题**：Streamlit在显示DataFrame时出现ArrowTypeError
**解决方案**：
- 确保DataFrame中的数据类型统一
- 对混合类型的字段进行预处理
- 转换时间字段为标准格式

### 6.3 股票数据获取失败

**问题**：无法获取股票数据或数据为空
**解决方案**：
- 检查AutoStock API的TOKEN是否有效
- 检查股票代码格式是否正确
- 考虑添加重试机制

## 7. 扩展接口说明

### 7.1 MCP工具服务

MCP服务提供了额外的工具调用能力，主要包括：
- 获取名人名言
- 获取励志语录
- 获取工作鸡汤

### 7.2 待实现接口

数据管理接口目前尚未完全实现，包括：
- 数据上传下载
- 数据创建删除
- 数据管理功能

## 8. 项目启动和部署

### 8.1 后端服务启动

```bash
# 运行主服务器
python main_server.py
# 或使用uvicorn
uvicorn main_server:app --host 0.0.0.0 --port 8000
```

### 8.2 前端服务启动

```bash
# 运行Streamlit应用
streamlit run demo/streamlit_demo.py
```

### 8.3 MCP服务启动

```bash
# 运行MCP服务器
python mcp_server_main.py
```

## 9. 接口调用示例

### 9.1 用户登录示例

```python
import requests

url = "http://localhost:8000/v1/users/login"
payload = {"user_name": "admin", "password": "123456"}
headers = {"Content-Type": "application/json"}

response = requests.post(url, json=payload, headers=headers)
print(response.json())
```

### 9.2 获取股票列表示例

```python
import requests

url = "http://localhost:8000/stock/get_stock_code"
params = {"keyword": "科技"}

response = requests.get(url, params=params)
print(response.json())
```

### 9.3 智能聊天示例

```python
import requests
import sseclient

# 初始化聊天
init_url = "http://localhost:8000/v1/chat/init"
init_response = requests.post(init_url)
session_id = init_response.json()["data"]["session_id"]

# 发送聊天消息
chat_url = "http://localhost:8000/v1/chat/"
payload = {
    "user_name": "admin",
    "session_id": session_id,
    "content": "如何分析股票走势？"
}
headers = {"Content-Type": "application/json"}

response = requests.post(chat_url, json=payload, headers=headers, stream=True)
client = sseclient.SSEClient(response)

# 处理流式响应
for event in client.events():
    print(event.data)
```

---

此文档详细描述了股票BI智能助手项目的前后端交互接口，包括API接口定义、数据模型、交互流程和使用示例，可作为开发和维护该项目的参考文档。