# 对多模态RAG的项目，设计数据管理的接口、多模态检索接口、多模态问答接口的接口定义、传入的参数以及返回的结果格式如下：

## 1. 数据管理接口

### 1.1 知识库管理
```python
# 创建知识库
POST /api/knowledge-bases
Request:
{
    "name": "string",           # 知识库名称
    "description": "string",    # 描述
    "permissions": {           # 权限配置
        "read_users": ["user1", "user2"],
        "write_users": ["user1", "admin"]
    }
}
Response:
{
    "kb_id": "string",
    "status": "success"
}

# 获取知识库列表
GET /api/knowledge-bases
Response:
{
    "knowledge_bases": [
        {
            "kb_id": "string",
            "name": "string",
            "description": "string",
            "document_count": 0,
            "created_at": "timestamp"
        }
    ]
}
```

### 1.2 文档上传与解析
```python
# 上传文档
POST /api/knowledge-bases/{kb_id}/documents
Request: multipart/form-data
- file: binary (PDF文件)
- metadata: {
    "title": "string",
    "author": "string",
    "tags": ["tag1", "tag2"]
}

Response:
{
    "document_id": "string",
    "task_id": "string",        # 解析任务ID
    "status": "uploaded"
}

# 查询文档解析状态
GET /api/documents/{document_id}/status
Response:
{
    "document_id": "string",
    "status": "parsing|completed|failed",
    "progress": 0.85,          # 解析进度 0-1
    "total_pages": 100,
    "parsed_pages": 85,
    "error_message": "string"   # 失败时的错误信息
}

# 获取文档列表
GET /api/knowledge-bases/{kb_id}/documents
Response:
{
    "documents": [
        {
            "document_id": "string",
            "title": "string",
            "file_name": "string",
            "page_count": 0,
            "status": "parsed|parsing|failed",
            "uploaded_at": "timestamp"
        }
    ]
}
```

### 1.3 文档内容管理
```python
# 获取文档解析结果
GET /api/documents/{document_id}/content
Response:
{
    "document_id": "string",
    "pages": [
        {
            "page_num": 1,
            "text_content": "markdown文本内容",
            "images": [
                {
                    "image_id": "string",
                    "image_path": "string",
                    "caption": "string",      # 图片描述
                    "position": {"x": 0, "y": 0, "width": 100, "height": 100}
                }
            ],
            "chunks": [         # 文本分块信息
                {
                    "chunk_id": "string",
                    "text": "string",
                    "start_index": 0,
                    "end_index": 100
                }
            ]
        }
    ]
}

# 删除文档
DELETE /api/documents/{document_id}
Response:
{
    "status": "success"
}
```

## 2. 多模态检索接口

### 2.1 混合检索
```python
# 多模态检索
POST /api/knowledge-bases/{kb_id}/retrieve
Request:
{
    "query": "string",                    # 检索内容，包括检索文本和/或图片base64编码
    "search_type": "hybrid|text|image",   # 检索类型
    "top_k": 10,                         # 返回结果数量
    "filters": {                         # 过滤条件
        "document_ids": ["doc1", "doc2"],
        "page_range": {"start": 1, "end": 50},
        "min_score": 0.7                 # 最小相似度分数
    }
}

Response:
{
    "query": "string",
    "results": {
        "text_results": [
            {
                "chunk_id": "string",
                "document_id": "string",
                "page_num": 1,
                "text": "检索到的文本片段",
                "score": 0.95,           # 相似度分数
                "metadata": {
                    "file_name": "string",
                    "title": "string",
                    "chunk_index": 0
                }
            }
        ],
        "image_results": [
            {
                "image_id": "string",
                "document_id": "string",
                "page_num": 1,
                "image_path": "string",
                "caption": "图片描述",
                "score": 0.88,           # CLIP相似度分数
                "metadata": {
                    "file_name": "string",
                    "title": "string",
                    "position": {"x": 0, "y": 0, "width": 100, "height": 100}
                }
            }
        ]
    },
    "search_time": 0.15                  # 检索耗时(秒)
}
```

### 2.2 检索配置
```python
# 更新检索配置
PUT /api/knowledge-bases/{kb_id}/retrieval-config
Request:
{
    "text_weight": 0.6,          # 文本检索权重
    "image_weight": 0.4,         # 图像检索权重
    "chunk_size": 512,           # 文本分块大小
    "chunk_overlap": 50,         # 分块重叠大小
    "max_images_per_page": 5     # 每页最大图片数
}
Response:
{
    "status": "success"
}
```

## 3. 多模态问答接口

### 3.1 问答对话
```python
# 多模态问答
POST /api/knowledge-bases/{kb_id}/chat
Request:
{
    "question": "string",                # 用户问题，包括提问文本和/或图片base64编码
    "conversation_id": "string",         # 会话ID(可选)
    "history": [                         # 对话历史(可选)
        {
            "role": "user|assistant",
            "content": "string",
            "sources": []               # 历史回答的引用来源
        }
    ],
    "retrieval_config": {               # 检索配置(可选)
        "top_k": 10,
        "min_score": 0.7
    },
    "generation_config": {              # 生成配置(可选)
        "max_tokens": 1000,
        "temperature": 0.7
    }
}

Response:
{
    "answer": "生成的答案文本，包含对图像和文本的综合理解",
    "conversation_id": "string",        # 会话ID
    "sources": [                        # 引用来源
        {
            "type": "text|image",       # 来源类型
            "content": "引用内容片段",   # 对于文本是片段，对于图片是描述
            "document_id": "string",
            "file_name": "string",
            "page_num": 1,
            "image_id": "string",       # 仅图片类型有
            "score": 0.92,              # 检索相似度
            "position": {               # 在文档中的位置
                "chunk_index": 0,       # 文本块索引
                "bbox": {"x": 0, "y": 0, "width": 100, "height": 100}  # 图片位置
            }
        }
    ],
    "retrieval_metrics": {              # 检索指标
        "text_results_count": 5,
        "image_results_count": 3,
        "retrieval_time": 0.12
    },
    "generation_metrics": {             # 生成指标
        "generation_time": 1.5,
        "token_count": 256
    }
}
```

### 3.2 会话管理
```python
# 获取会话历史
GET /api/conversations/{conversation_id}
Response:
{
    "conversation_id": "string",
    "knowledge_base_id": "string",
    "messages": [
        {
            "role": "user|assistant",
            "content": "string",
            "timestamp": "timestamp",
            "sources": []               # 引用来源
        }
    ],
    "created_at": "timestamp"
}

# 删除会话
DELETE /api/conversations/{conversation_id}
Response:
{
    "status": "success"
}
```

## 4. 系统管理接口

### 4.1 健康检查
```python
GET /api/health
Response:
{
    "status": "healthy",
    "services": {
        "database": "connected",
        "milvus": "connected", 
        "qwen_vl": "available",
        "clip": "available",
        "ocr": "available"
    },
    "version": "1.0.0"
}
```

### 4.2 统计信息
```python
GET /api/knowledge-bases/{kb_id}/stats
Response:
{
    "document_count": 10,
    "total_pages": 500,
    "total_images": 150,
    "total_chunks": 2500,
    "storage_usage": {
        "documents": "1.2GB",
        "images": "500MB",
        "vectors": "800MB"
    }
}
```

## 错误处理
所有接口都遵循统一的错误格式：
```python
{
    "error": {
        "code": "ERROR_CODE",        # 错误码
        "message": "错误描述",        # 用户可读的错误信息
        "details": {}                # 详细错误信息(开发用)
    }
}
```

错误码可以如下定义，根据项目细节及规范可以做适当增删改等调整：
- `INVALID_PARAMETER`: 参数验证失败
- `KNOWLEDGE_BASE_NOT_FOUND`: 知识库不存在
- `DOCUMENT_NOT_FOUND`: 文档不存在
- `PERMISSION_DENIED`: 权限不足
- `PARSING_IN_PROGRESS`: 文档解析中
- `MODEL_UNAVAILABLE`: 模型服务不可用
