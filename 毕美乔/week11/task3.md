# ã€task3ã€‘

**å¯¹å¤šæ¨¡æ€RAGçš„é¡¹ç›®ï¼Œmilvuså¦‚æœè¦å­˜å‚¨æ–‡æœ¬ã€å›¾ã€è¡¨ï¼Œæ•°æ®ç»“æ„å¦‚ä½•è®¾è®¡ï¼Ÿ**

Milvus åªåšä¸€ä»¶äº‹ï¼š
  ç”¨å‘é‡ï¼Œå¸®ä½ â€œæ‰¾åˆ° chunk_idâ€ã€‚

æ‰€ä»¥ä¸€å¥è¯ç»“è®ºæ˜¯ï¼š
  - âŒ ä¸åœ¨ Milvus å­˜â€œçŸ¥è¯†å†…å®¹â€
  - âŒ ä¸åœ¨ Milvus å­˜å®Œæ•´ PDF / æ–‡æœ¬ / å›¾åƒ
  - âœ… åªå­˜å‘é‡ + æœ€å°å¯å®šä½çš„å…ƒæ•°æ®

## ä¸€ã€å¤šæ¨¡æ€ RAG ä¸­çš„ä¸‰ç±»â€œå¯æ£€ç´¢å¯¹è±¡â€  

é¡¹ç›®é‡Œï¼Œå‚ä¸æ£€ç´¢çš„å¯¹è±¡åªæœ‰ä¸‰ç±»ï¼š

 æ¨¡æ€                      | æ˜¯å¦è¿› Milvus | è¯´æ˜               |
| ----------------------- | ---------- | ---------------- |
| æ–‡æœ¬ï¼ˆparagraph / captionï¼‰ | âœ…          | è¯­ä¹‰æ£€ç´¢ä¸»åŠ›           |
| å›¾åƒï¼ˆfigure / chartï¼‰      | âœ…          | è§†è§‰ç›¸ä¼¼åº¦            |
| è¡¨æ ¼ï¼ˆtableï¼‰               | âš ï¸ çœ‹å¤„ç†æ–¹å¼   | æœ¬è´¨æ˜¯ text æˆ– image |

âš ï¸ **å…³é”®ç‚¹**ï¼š
ä¸æ˜¯â€œæ–‡ / å›¾ / è¡¨â€ï¼Œè€Œæ˜¯**å®ƒä»¬æ˜¯å¦æœ‰ embedding**

## äºŒã€æ€»ä½“è®¾è®¡
```
Milvus
â”œâ”€â”€ text_chunk_collection
â”œâ”€â”€ image_chunk_collection
â””â”€â”€ table_chunk_collectionï¼ˆå¯é€‰ï¼‰
```
## ä¸‰ã€æ¯ç§ collection çš„æ•°æ®ç»“æ„è®¾è®¡

### 1ï¸âƒ£ æ–‡æœ¬ chunk collectionï¼ˆTextIndexï¼‰

**é€‚åˆå¯¹è±¡**
  - æ­£æ–‡æ®µè½
  - å›¾æ³¨ï¼ˆcaptionï¼‰
  - è¡¨æ ¼è½¬æ–‡æœ¬åçš„æè¿°
  - æ•°æ®ç»“æ„

**æ•°æ®ç»“æ„**
```
{
  "chunk_id": "uuid",
  "document_id": "doc_001",
  "page_no": 5,
  "chunk_type": "text",              // enum: text / caption / table_text
  "embedding": [float32, 768],
  "text_len": 320,
  "has_image": true                  // æ˜¯å¦å…³è”å›¾
}
```

**è¯´æ˜**
  - chunk_id æ˜¯è·¨æ¨¡æ€ç»Ÿä¸€ä¸»é”®
  - has_image ç”¨äº rerank / è¿‡æ»¤
  - **ä¸å­˜å…·ä½“æ–‡æœ¬å†…å®¹**

### 2ï¸âƒ£ å›¾åƒ chunk collectionï¼ˆImageIndexï¼‰

**é€‚åˆå¯¹è±¡**
  - PDF ä¸­çš„ figure
  - å›¾è¡¨ã€æµç¨‹å›¾ã€ç¤ºæ„å›¾

**æ•°æ®ç»“æ„**
```
{
  "chunk_id": "uuid",                // ä¸ text chunk å…±äº«æˆ–å…³è”
  "document_id": "doc_001",
  "page_no": 5,
  "chunk_type": "image",             // image / chart / diagram
  "embedding": [float32, 512],
  "image_id": "img_005",
  "has_caption": true
}
```

**è¯´æ˜**
  - embedding æ¥è‡ª CLIP / SigLIP / BLIP
  - image_id ç”¨äºå›è¡¨å–çœŸå®å›¾ç‰‡
  - **ä¸å­˜å›¾ç‰‡æœ¬ä½“**

## 3ï¸âƒ£ è¡¨æ ¼ chunk collectionï¼ˆTableIndexï¼ŒæŒ‰ç­–ç•¥ï¼‰
è¡¨æ ¼æœ‰ä¸‰ç§ä¸»æµå¤„ç†æ–¹å¼
  - âœ… æ–¹æ³• Aï¼ˆæœ€å¸¸ç”¨ï¼Œæ¨èï¼‰
    è¡¨æ ¼ â†’ ç»“æ„åŒ–æ–‡æœ¬ â†’ TextIndex
    ```
    è¡¨æ ¼ â†’ markdown / è¡Œæè¿° â†’ text embedding
    ```
    ğŸ‘‰ ä¸å•ç‹¬å»ºè¡¨æ ¼ index

  - âš ï¸ æ–¹æ³• Bï¼ˆå¤æ‚è¡¨æ ¼ï¼‰
    è¡¨æ ¼ â†’ å›¾åƒ + æ–‡æœ¬åŒç´¢å¼•
    ```
    è¡¨æ ¼æˆªå›¾ â†’ ImageIndex
    è¡¨æ ¼ç»“æ„æè¿° â†’ TextIndex
    ```

  - âŒ æ–¹æ³• Cï¼ˆç›´æ¥æ•°å€¼è¡¨è¿› Milvusï¼‰
    ä¸€èˆ¬ä¸æ¨èï¼ˆæ£€ç´¢ä»·å€¼ä½ï¼‰

## å››ã€chunk_id å¦‚ä½•è®¾è®¡ï¼ˆéå¸¸å…³é”®ï¼‰
æ ¸å¿ƒåŸåˆ™
**chunk_id æ˜¯è·¨æ¨¡æ€â€œé”šç‚¹â€ï¼Œä¸æ˜¯ Milvus è‡ªå¢ ID**

æ¨èæ ¼å¼ï¼š
```
chunk_id = doc_id + page_no + block_id
```

ä¾‹å¦‚ï¼š
```
doc001_p05_b03
```

è¿™æ ·ä½ å¯ä»¥ï¼š
  - text chunk
  - image chunk
  - table chunk
ğŸ‘‰ å…±äº«æˆ–æŒ‡å‘åŒä¸€ä¸ª chunk_id

## äº”ã€é‚£â€œå›¾æ–‡ chunkâ€æ€ä¹ˆä½“ç°ï¼Ÿ

æ³¨æ„ï¼š
**Milvus é‡Œæ²¡æœ‰â€œå›¾æ–‡æ··åˆ chunkâ€**

è€Œæ˜¯ï¼š
```
TextIndex   â†’ chunk_id = c003
ImageIndex  â†’ chunk_id = c003
```

è¿™å°±å½¢æˆäº†ä¹‹å‰æåˆ°çš„ï¼š
**æ–‡æœ¬ + å›¾åƒåŒé‡å‘½ä¸­ï¼ˆretrieval stateï¼‰**
å³ï¼š
å„æ¨¡æ€å‘é‡ç´¢å¼• collection ä¸­ä¸ä¾èµ–è‡ªå¢ ID ä½œä¸ºä¸šåŠ¡ä¸»é”®ï¼Œ
è€Œæ˜¯é‡‡ç”¨ç»Ÿä¸€çš„ chunk_id ä½œä¸ºè·¨æ¨¡æ€å¯¹é½ä¸æ£€ç´¢ç»“æœå›æº¯çš„å”¯ä¸€æ ‡è¯†ã€‚
Milvus å†…éƒ¨ auto_id ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ä»…ä½œä¸ºå­˜å‚¨å®ç°ç»†èŠ‚ï¼Œä¸æš´éœ²è‡³ä¸šåŠ¡å±‚ã€‚

## å…­ã€ä¸€æ¬¡å®Œæ•´æ£€ç´¢ä¸­ Milvus åšäº†ä»€ä¹ˆï¼Ÿ

æ–‡æœ¬ + å›¾åƒæé—®æ—¶ï¼š
```
text_hits  = milvus_text.search(text_embedding)
image_hits = milvus_image.search(image_embedding)
```

å¾—åˆ°çš„æ˜¯ï¼š
```
text_hits  â†’ [chunk_id, score]
image_hits â†’ [chunk_id, score]
```

ä¹‹åï¼š
```
merge by chunk_id
â†’ å½¢æˆ retrieval_state
â†’ rerank
```

ğŸ“Œ **Milvus æ°¸è¿œä¸çŸ¥é“ä½ åœ¨åšâ€œå¤šæ¨¡æ€ RAGâ€**
å®ƒåªæ˜¯åœ¨åšå‘é‡è¿‘é‚»æœç´¢ã€‚

